!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).myLibrary={})}(this,(function(e){"use strict";function t(e){return(t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function i(e){return(i=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function u(e,t,n){return(u="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=i(e)););return e}(e,t);if(r){var u=Object.getOwnPropertyDescriptor(r,t);return u.get?u.get.call(n):u.value}})(e,t,n||e)}function o(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function a(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return o(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?o(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var u,a=!0,f=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return a=e.done,e},e:function(e){f=!0,u=e},f:function(){try{a||null==n.return||n.return()}finally{if(f)throw u}}}}var f=require("./int64-buffer.min.js").Int64BE,s={chunkSize:15872,txSendTTL:3e4,maxBufferedAmount:65536};function c(e,t){var n,r=0,i=a(t);try{for(i.s();!(n=i.n()).done;){r+=n.value.length}}catch(e){i.e(e)}finally{i.f()}var u,o=new e(r),f=0,s=a(t);try{for(s.s();!(u=s.n()).done;){var c=u.value;o.set(c,f),f+=c.length}}catch(e){s.e(e)}finally{s.f()}return o}var l=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:s;n(this,e),this._opts=Object.assign({},t,s),this._txOrdinal=0,this._rxPackets=[],this._txPause=!1,this.webRTCMessageQueue=[],this.webRTCPaused=!1}var o,a,l;return o=e,(a=[{key:"chunkSize",get:function(){return this._opts.chunkSize}},{key:"txSendTTL",get:function(){return this._opts.txSendTTL}},{key:"maxBufferedAmount",get:function(){return this._opts.maxBufferedAmount}},{key:"encodePacket",value:function(e){var t=e.chunk,n=e.txOrd,r=e.index,i=e.length,u=e.totalSize,o=e.chunkSize;return c(Uint8Array,[new Uint8Array(new f(n).toArrayBuffer()),new Uint8Array(new f(r).toArrayBuffer()),new Uint8Array(new f(i).toArrayBuffer()),new Uint8Array(new f(u).toArrayBuffer()),new Uint8Array(new f(o).toArrayBuffer()),t])}},{key:"decodePacket",value:function(e){return{txOrd:new f(e.slice(0,8)).toNumber(),index:new f(e.slice(8,16)).toNumber(),length:new f(e.slice(16,24)).toNumber(),totalSize:new f(e.slice(24,32)).toNumber(),chunkSize:new f(e.slice(32,40)).toNumber(),chunk:e.slice(40)}}},{key:"packetArray",value:function(e,t){var n=this,r=this._txOrdinal;this._txOrdinal++;for(var i=[],u=e.length||e.byteLength,o=0;o<u;)i.push(e.slice(o,t+o)),o+=t;return i.map((function(e,t){return n.encodePacket({chunk:e,txOrd:r,index:t,totalSize:u,length:i.length,chunkSize:e.byteLength})}))}},{key:"_onChannelMessage",value:function(e){var t=this,n=e.data,r=this.decodePacket(n);if(r.chunk instanceof ArrayBuffer&&(r.chunk=new Uint8Array(r.chunk)),r.chunkSize===r.totalSize)this.push(r.chunk);else{var i=this._rxPackets.filter((function(e){return e.txOrd===r.txOrd}));i.push(r);var u=i.map((function(e){return e.index}));if(new Set(u).size===r.length){i.sort(this.sortPacketArray);var o=c(Uint8Array,i.map((function(e){return e.chunk})));this.push(o),setTimeout((function(){t._rxPackets=t._rxPackets.filter((function(e){return e.txOrd!==r.txOrd}))}),this.txSendTTL)}else this._rxPackets.push(r)}}},{key:"sortPacketArray",value:function(e,t){return e.index>t.index?1:-1}},{key:"send",value:function(e){e instanceof ArrayBuffer&&(e=new Uint8Array(e));var t=this.packetArray(e,this.chunkSize);this.webRTCMessageQueue=this.webRTCMessageQueue.concat(t),this.webRTCPaused||this.sendMessageQueued()}},{key:"sendMessageQueued",value:function(){var n=this;this.webRTCPaused=!1;for(var r=this.webRTCMessageQueue.shift();r;){if(this._channel.bufferedAmount&&this._channel.bufferedAmount>this.maxBufferedAmount){var o=(n.webRTCPaused=!0,n.webRTCMessageQueue.unshift(r),n._channel.addEventListener("bufferedamountlow",(function e(){n._channel.removeEventListener("bufferedamountlow",e),n.sendMessageQueued()})),{v:void 0});if("object"===t(o))return o.v}try{u(i(e.prototype),"send",this).call(this,r),r=this.webRTCMessageQueue.shift()}catch(e){console.warn(e)}}}}])&&r(o.prototype,a),l&&r(o,l),e}(),h=function(e,t){return Object.assign(e,new l(t))};e.SimplePeerDataPackets=l,e.default=h,e.wrapSimplePeer=h}));
//# sourceMappingURL=simple-peer-data-packets.min.js.map
