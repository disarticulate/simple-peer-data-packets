{"version":3,"file":"index.js","sources":["../../src/SimplePeerDataPackets.js","../../src/index.js"],"sourcesContent":["const { Int64BE } = require('./int64-buffer.min.js')\n\nconst CHUNK_SIZE = (1024 * 16) - 512 // 16KB - data header\nconst TX_SEND_TTL = 1000 * 30 // 30 seconds\nconst MAX_BUFFERED_AMOUNT = 64 * 1024 // simple peer value\nconst defaultOpts = {\n   chunkSize: CHUNK_SIZE,\n   txSendTTL: TX_SEND_TTL,\n   maxBufferedAmount: MAX_BUFFERED_AMOUNT\n}\n\n\nfunction concatenate (Constructor, arrays) {\n  let totalLength = 0\n  for (const arr of arrays) totalLength += arr.length\n  const result = new Constructor(totalLength)\n  let offset = 0\n  for (const arr of arrays) {\n    result.set(arr, offset)\n    offset += arr.length\n  }\n  return result\n}\n\nclass SimplePeerDataPackets {\n  constructor (opts = defaultOpts) {\n    this._opts = Object.assign({}, opts, defaultOpts)\n    this._txOrdinal = 0\n    this._rxPackets = []\n    this._txPause = false\n    this.webRTCMessageQueue = []\n    this.webRTCPaused = false\n  }\n\n  get chunkSize () { return this._opts.chunkSize }\n  get txSendTTL () { return this._opts.txSendTTL }\n  get maxBufferedAmount () { return this._opts.maxBufferedAmount }\n\n  encodePacket ({ chunk, txOrd, index, length, totalSize, chunkSize }) {\n    const encoded = concatenate(Uint8Array, [\n      new Uint8Array(new Int64BE(txOrd).toArrayBuffer()), // 8 bytes\n      new Uint8Array(new Int64BE(index).toArrayBuffer()), // 8 bytes\n      new Uint8Array(new Int64BE(length).toArrayBuffer()), // 8 bytes\n      new Uint8Array(new Int64BE(totalSize).toArrayBuffer()), // 8 bytes\n      new Uint8Array(new Int64BE(chunkSize).toArrayBuffer()), // 8 bytes\n      chunk // CHUNK_SIZE\n    ])\n    return encoded\n  }\n\n  decodePacket (array) {\n    return {\n      txOrd: new Int64BE(array.slice(0, 8)).toNumber(),\n      index: new Int64BE(array.slice(8, 16)).toNumber(),\n      length: new Int64BE(array.slice(16, 24)).toNumber(),\n      totalSize: new Int64BE(array.slice(24, 32)).toNumber(),\n      chunkSize: new Int64BE(array.slice(32, 40)).toNumber(),\n      chunk: array.slice(40)\n    }\n  }\n\n  packetArray (array, size) {\n    const txOrd = this._txOrdinal\n    this._txOrdinal++\n    const chunkedArr = []\n    const totalSize = array.length || array.byteLength\n    let index = 0\n    while (index < totalSize) {\n      chunkedArr.push(array.slice(index, size + index))\n      index += size\n    }\n    return chunkedArr.map((chunk, index) => {\n      return this.encodePacket({\n        chunk,\n        txOrd,\n        index,\n        totalSize,\n        length: chunkedArr.length,\n        chunkSize: chunk.byteLength\n      })\n    })\n  }\n\n  _onChannelMessage (event) {\n    const { data } = event\n    const packet = this.decodePacket(data)\n    if (packet.chunk instanceof ArrayBuffer) packet.chunk = new Uint8Array(packet.chunk)\n    if (packet.chunkSize === packet.totalSize) {\n      this.push(packet.chunk)\n    } else {\n      const data = this._rxPackets.filter((p) => p.txOrd === packet.txOrd)\n      data.push(packet)\n      const indices = data.map(p => p.index)\n      if (new Set(indices).size === packet.length) {\n        data.sort(this.sortPacketArray)\n        const chunks = concatenate(Uint8Array, data.map(p => p.chunk))\n        this.push(chunks)\n        setTimeout(() => { this._rxPackets = this._rxPackets.filter((p) => p.txOrd !== packet.txOrd) }, this.txSendTTL)\n      } else {\n        this._rxPackets.push(packet)\n      }\n    }\n  }\n\n  sortPacketArray (a, b) { return a.index > b.index ? 1 : -1 }\n  send (chunk) {\n    if (chunk instanceof ArrayBuffer) chunk = new Uint8Array(chunk)\n    const chunks = this.packetArray(chunk, this.chunkSize)\n    this.webRTCMessageQueue = this.webRTCMessageQueue.concat(chunks)\n    if (this.webRTCPaused) return\n    this.sendMessageQueued()\n  }\n\n  sendMessageQueued () {\n    this.webRTCPaused = false\n    let message = this.webRTCMessageQueue.shift()\n    while (message) {\n      if (this._channel.bufferedAmount && this._channel.bufferedAmount > this.maxBufferedAmount) {\n        this.webRTCPaused = true\n        this.webRTCMessageQueue.unshift(message)\n        const listener = () => {\n          this._channel.removeEventListener('bufferedamountlow', listener)\n          this.sendMessageQueued()\n        }\n        this._channel.addEventListener('bufferedamountlow', listener)\n        return\n      }\n      try {\n        super.send(message)\n        message = this.webRTCMessageQueue.shift()\n      } catch (error) {\n        console.warn(error)\n      }\n    }\n  }\n}\n\nexport default SimplePeerDataPackets\n","import SimplePeerDataPackets from './SimplePeerDataPackets'\nexport const wrapSimplePeer = (simplepeer, opts) => {\n  return Object.assign(simplepeer, new SimplePeerDataPackets(opts))\n}\nexport {\n  SimplePeerDataPackets\n}\nexport default wrapSimplePeer"],"names":[],"mappings":"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"}